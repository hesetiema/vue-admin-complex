# ç½‘ç»œè¯·æ±‚ ðŸŸ

## ðŸ“  Ajax(XHR)

### 1ã€Ajax

> Ajaxï¼šå…¨ç§° Asynchronous JavaScript + XMLï¼ˆå¼‚æ­¥ JavaScript å’Œ XMLï¼‰

- Ajax å‡ºçŽ°å‰ï¼Œä»»ä½•å’ŒæœåŠ¡å™¨çš„äº¤äº’éƒ½éœ€è¦åˆ·æ–°é¡µé¢ï¼Œç”¨æˆ·ä½“éªŒéžå¸¸å·®
- Ajax å‡ºçŽ°åŽï¼Œç½‘é¡µåº”ç”¨èƒ½å¤Ÿ**å¿«é€Ÿåœ°å°†å¢žé‡æ›´æ–°å‘ˆçŽ°åœ¨ç”¨æˆ·ç•Œé¢ä¸Šï¼Œä¸éœ€é‡è½½ï¼ˆåˆ·æ–°ï¼‰æ•´ä¸ªé¡µé¢**

### 2ã€XHR

æµè§ˆå™¨çš„** XMLHttpRequest æ˜¯å®žçŽ° Ajax æœ€é‡è¦çš„å¯¹è±¡ï¼Œ**ç”±`let xhr = new XMLHttpRequest();`åˆ›å»ºä¸€ xhr å®žä¾‹

- æ–¹æ³•
  - openï¼šåˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚ã€‚`xhr.open(method, url, async);`
  - sendï¼šå‘é€ HTTP è¯·æ±‚ã€‚`xhr.send(param);`
  - abortï¼šç»ˆæ­¢ä¸€ä¸ª ajax è¯·æ±‚ã€‚`xhr.abort()`ï¼ŒreadyState å°†è¢«è®¾ç½®ä¸º 0
  - setRequestHeaderï¼šè®¾ç½® http è¯·æ±‚å¤´ã€‚`xhr.setRequestHeader(header, value);`åœ¨ open()ã€send()é—´è°ƒç”¨
  - getResponseHeaderï¼šèŽ·å– http è¿”å›žå¤´ã€‚`let header= xhr.getResponseHeader(name);`
- å±žæ€§
  - readyStateï¼šæ ‡è¯†å½“å‰ XMLHttpRequest å¯¹è±¡æ‰€å¤„çš„çŠ¶æ€
  - statusï¼šè¡¨ç¤º http è¯·æ±‚çš„çŠ¶æ€, åˆå§‹å€¼ä¸º 0ã€‚å¦‚æžœæœåŠ¡å™¨æ²¡æœ‰æ˜¾å¼åœ°æŒ‡å®šçŠ¶æ€ç , é‚£ä¹ˆ status å°†è¢«è®¾ç½®ä¸ºé»˜è®¤å€¼, å³ 200ã€‚
  - responseTypeï¼šè¡¨ç¤ºå“åº”çš„æ•°æ®ç±»åž‹ï¼Œå¹¶å…è®¸æˆ‘ä»¬æ‰‹åŠ¨è®¾ç½®ï¼Œå¦‚æžœä¸ºç©ºï¼Œé»˜è®¤ä¸º text ç±»åž‹
  - responseï¼šè¿”å›žå“åº”çš„æ­£æ–‡
  - withCredentialsï¼šwithCredentials çš„å±žæ€§ä¸º true å°†å…è®¸æºå¸¦è·¨åŸŸ cookie
- äº‹ä»¶å›žè°ƒ
  - onreadystatechangeï¼šå½“ readyState å±žæ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œcallback ä¼šè¢«è§¦å‘ã€‚
  - onloadstartï¼šåœ¨ ajax è¯·æ±‚å‘é€ä¹‹å‰ï¼ˆ`readyState==1` åŽ, `readyState==2` å‰ï¼‰ï¼Œcallback ä¼šè¢«è§¦å‘ã€‚
  - onprogressï¼šå›žè°ƒå‡½æ•°å¯ä»¥èŽ·å–èµ„æºæ€»å¤§å° totalï¼Œå·²ç»åŠ è½½çš„èµ„æºå¤§å° loadedï¼Œç”¨è¿™ä¸¤ä¸ªå€¼å¯ä»¥è®¡ç®—åŠ è½½è¿›åº¦ã€‚
    - `xhr.onprogress = function(event){console.log(event.loaded / event.total);}`
  - onloadï¼šå½“ä¸€ä¸ªèµ„æºåŠå…¶ä¾èµ–èµ„æºå·²å®ŒæˆåŠ è½½æ—¶ï¼Œå°†è§¦å‘ callbackï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨ onload äº‹ä»¶ä¸­å¤„ç†è¿”å›žå€¼
- å¼‚å¸¸å¤„ç†
  - onerrorï¼šå½“ ajax èµ„æºåŠ è½½å¤±è´¥æ—¶ä¼šè§¦å‘ callbackã€‚
  - ontimeoutï¼šå½“è¿›åº¦ç”±äºŽé¢„å®šæ—¶é—´åˆ°æœŸè€Œç»ˆæ­¢æ—¶ï¼Œä¼šè§¦å‘ callbackï¼Œè¶…æ—¶æ—¶é—´å¯ä½¿ç”¨ timeout å±žæ€§è¿›è¡Œè®¾ç½®ã€‚

```javascript
let xhr = new XMLHttpRequest();
xhr.open("GET", "/my/url");
xhr.withCredentials = true;
xhr.setRequestHeader("Content-Type", "application/json");
xhr.responseType = "json";
xhr.send();
xhr.onload = function () {
  if (xhr.status != 200) {
    // HTTP å‡ºé”™ï¼Ÿ
    // å¤„ç†é”™è¯¯
    alert("Error: " + xhr.status);
    return;
  }
  // ä»Ž xhr.response ä¸­èŽ·å–å“åº”
};
xhr.onerror = function () {
  console.log("Network request failed");
};
```

## ðŸ„Fetch

> Fetch API æ˜¯ä¸€ä¸ªç”¨äºŽè®¿é—®å’Œæ“çºµ HTTP ç®¡é“çš„å¼ºå¤§çš„åŽŸç”Ÿ API

### 1ã€è¯·æ±‚

æµè§ˆå™¨ç«‹å³å‘é€è¯·æ±‚ï¼Œå¹¶è¿”å›žä¸€ä¸ª promise

```javascript
const options = {
  method: "POST",
  mode: "cors" // è·¨åŸŸ
  headers: {
    "Content-Type": "application/json"
  }, // è®¾ç½®è¯·æ±‚å¤´
  body: JSON.stringify({ name: "123" }), // è¯·æ±‚å‚æ•°
  credentials: "include", // éœ€å‘é€å‡­æ®
};
let promise = fetch(url, options);
```

### 2ã€èŽ·å–å“åº”çŠ¶æ€å¹¶è§£æžå“åº”ä½“

- å±žæ€§
  - response.ok â€”â€” å¸ƒå°”å€¼ï¼Œè‹¥ HTTP çŠ¶æ€ç åœ¨ 200-299 ä¹‹é—´ï¼Œè¿”å›ž true
  - response.status â€”â€” HTTP çŠ¶æ€ç 
  - response.headers â€”â€” ç±»ä¼¼äºŽ Map çš„ headers å¯¹è±¡,å¯èŽ·å–å•ä¸ªæˆ–è¿­ä»£å®ƒä»¬
  - response.body â€”â€” ReadableStream å¯¹è±¡ï¼Œå…è®¸é€å—è¯»å–æ­£æ–‡ï¼Œè¿½è¸ª download è¿‡ç¨‹
    - å¯åŠ¨ fetch å¹¶èµ‹å€¼ç»™ reader(æµè¯»å–å™¨)ï¼š
      - `const reader = response.body.getReader();`
    - ä»Ž Content-Length å¤´ä¸­æ‰¾å‡ºå®Œæ•´å“åº”é•¿åº¦ï¼ŒèŽ·å¾—æ€»é•¿åº¦ï¼ˆæ€»å—æ•°ï¼‰
      - `const contentLength = +response.headers.get('Content-Length');`
    - è¯»å–æ•°æ®ï¼Œè°ƒç”¨`await reader.read()`ç›´åˆ°å®ƒå·²ç»å®Œæˆ
    - å°†å—åˆå¹¶æˆå•ä¸ª`Uint8Array`å­—èŠ‚å—
    - è§£ç æˆå­—ç¬¦ä¸²
- æ–¹æ³•ï¼šResponse æä¾›äº†å¤šç§åŸºäºŽ promise æ–¹æ³•æ¥èŽ·å–ä¸åŒæ ¼å¼çš„å“åº”æ­£æ–‡
  - response.json() â€”â€” å°† response è§£æžä¸º JSON å¯¹è±¡
  - response.text() â€”â€” ä»¥æ–‡æœ¬å½¢å¼è¿”å›ž response
  - response.formData() â€”â€” ä»¥ FormData å¯¹è±¡ï¼ˆform/multipart ç¼–ç ï¼‰çš„å½¢å¼è¿”å›ž response
  - response.blob() â€”â€” ä»¥ Blobï¼ˆå…·æœ‰ç±»åž‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼‰å½¢å¼è¿”å›ž response
  - response.arrayBuffer() â€”â€” ä»¥ ArrayBuffer(çº¯äºŒè¿›åˆ¶æ•°æ®)å½¢å¼è¿”å›ž response

```javascript
//awaitæ–¹æ³•
let response = await fetch(url, options); //è§£æž response headers
if (response.ok) {
  // å¦‚æžœ HTTP çŠ¶æ€ç åœ¨ 200-299 ä¹‹é—´ï¼ŒèŽ·å–å“åº”ä½“ï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰
  let result = await response.json(); // ä»¥ JSON å½¢å¼è¯»å–æ•°æ®
  console.log(result);
} else {
  alert("HTTP-Error: " + response.status);
}
//çº¯ promise æ–¹æ³•
fetch(url, options)
  .then((response) => response.json())
  .then((result) => {
    console.log(result);
  }) // å“åº”æ•°æ®
  .catch((err) => {
    console.log(err);
  }); // å¼‚å¸¸å¤„ç†
```

### 3ã€ä¸­æ­¢(abort)

ä¸€ä¸ªç‰¹æ®Šçš„å†…ç½®å¯¹è±¡ï¼šAbortControllerã€‚å¯æ‰©å±•çš„ï¼Œå®ƒå…è®¸åŒæ—¶å–æ¶ˆå¤šä¸ª fetch

```javascript
// 1 ç§’åŽä¸­æ­¢
let controller = new AbortController();
setTimeout(() => controller.abort(), 1000);
try {
  let response = await fetch(url, {
    signal: controller.signal,
  });
} catch (err) {
  if (err.name == "AbortError") {
    // handle abort()
    alert("Aborted!");
  } else {
    throw err;
  }
}
```

## ðŸŽ·Axios

> axios åŠŸèƒ½ï¼šä»Žæµè§ˆå™¨ä¸­åˆ›å»º XMLHttpRequestsã€ä»Ž node.js åˆ›å»º http è¯·æ±‚ã€æ”¯æŒ Promise APIã€æ‹¦æˆªè¯·æ±‚å’Œå“åº”ã€è½¬æ¢è¯·æ±‚æ•°æ®å’Œå“åº”æ•°æ®ã€å–æ¶ˆè¯·æ±‚ã€è‡ªåŠ¨è½¬æ¢ JSON æ•°æ®ã€å®¢æˆ·ç«¯æ”¯æŒé˜²å¾¡ XSRF

### 1ã€axios API

- axios(config)

```javascript
// GET request for remote image
axios({
  method: "get",
  url: "http://bit.ly/2mTM3nY",
  responseType: "stream",
}).then(function (response) {
  response.data.pipe(fs.createWriteStream("ada_lovelace.jpg"));
});
```

- axios(url[,config])ï¼š`axios('/user/12345');// Send a GET request (default)`

### 2ã€åˆ«åè¯·æ±‚æ–¹æ³•

- axios.request(config)
- axios.get(url[, config])
- axios.delete(url[, config])
- axios.head(url[, config])
- axios.options(url[, config])
- axios.post(url[, data[, config]])
- axios.put(url[, data[, config]])
- axios.patch(url[, data[, config]])

### 3ã€è¯·æ±‚é…ç½®é€‰é¡¹

```javascript
{
  url: '/user',
  method: 'get', // default
  baseURL: 'https://some-domain.com/api/',
  transformRequest: [function (data, headers) {
    //  transformRequestæ–¹æ³•å…è®¸åœ¨è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ä¹‹å‰ä¿®æ”¹è¯¥è¯·æ±‚
    // åªé€‚ç”¨äºŽPUTã€POSTã€PATCHæ–¹æ³•ä¸­
    // æœ€åŽå¿…é¡»è¿”å›žä¸€ä¸ªstringã€ArrayBufferæˆ–è€…Streamã€‚
    return data;
  }],
  transformResponse: [function (data) {
    // transformResponseæ–¹æ³•å…è®¸åœ¨æ•°æ®ä¼ é€’åˆ°then/catchä¹‹å‰ä¿®æ”¹responseæ•°æ®
    // æ­¤æ–¹æ³•æœ€åŽä¹Ÿè¦è¿”å›žæ•°æ®
    return data;
  }],
  headers: {'X-Requested-With': 'XMLHttpRequest'},// å‘é€è‡ªå®šä¹‰Headerså¤´æ–‡ä»¶
  params: {
    ID: 12345
  },// å‘é€è¯·æ±‚çš„æŸ¥è¯¢å‚æ•°å¯¹è±¡ï¼Œæ‹¼æŽ¥æˆ url?param1=value1&param2=value2
  data: {
    firstName: 'Fred'
  },// dataæ˜¯åœ¨å‘é€POSTã€PUTæˆ–è€…PATCHè¯·æ±‚çš„æ•°æ®å¯¹è±¡
  timeout: 1000, // default is `0` (no timeout)
  withCredentials: false, // default
  adapter: function (config) {
    /* adapterå…è®¸ç”¨æˆ·å¤„ç†æ›´æ˜“äºŽæµ‹è¯•çš„è¯·æ±‚ã€‚è¿”å›žPromiseå’Œä¸€ä¸ªæœ‰æ•ˆçš„response */
  },
  auth: {
    // authè¡¨æ˜Žæä¾›å‡­è¯ç”¨äºŽå®Œæˆhttpçš„èº«ä»½éªŒè¯ã€‚
    //è¿™å°†ä¼šåœ¨headersä¸­è®¾ç½®ä¸€ä¸ªAuthorizationæŽˆæƒä¿¡æ¯ã€‚
    //è‡ªå®šä¹‰AuthorizationæŽˆæƒè¦è®¾ç½®åœ¨headersä¸­
    username: 'janedoe',
    password: 's00pers3cret'
  },
  responseType: 'json', // default
  responseEncoding: 'utf8', // default
  xsrfCookieName: 'XSRF-TOKEN', // default
  xsrfHeaderName: 'X-XSRF-TOKEN', // default
  onUploadProgress: function (progressEvent) {
    // Do whatever you want with the native progress event
  },
  onDownloadProgress: function (progressEvent) {
    // Do whatever you want with the native progress event
  },
  maxContentLength: 2000,
  validateStatus: function (status) {
    return status >= 200 && status < 300; // default
  },
  maxRedirects: 5, // default
  socketPath: null, // default
  httpAgent: new http.Agent({ keepAlive: true }),
  httpsAgent: new https.Agent({ keepAlive: true }),
  proxy: {
    host: '127.0.0.1',
    port: 9000,
    auth: {
      username: 'mikeymike',
      password: 'rapunz3l'
    }
  },
  cancelToken: new CancelToken(function (cancel) {
  })
}
```

### 4ã€å“åº”ä¿¡æ¯

```javascript
{
  // `data` is the response that was provided by the server
  data: {},
  status: 200,
  statusText: 'OK',

  headers: {},
  config: {},
  request: {}
}
```

### 5ã€æ‹¦æˆªå™¨

```javascript
// Add a request interceptor
axios.interceptors.request.use(
  function (config) {
    // Do something before request is sent
    return config;
  },
  function (error) {
    // Do something with request error
    return Promise.reject(error);
  }
);

// Add a response interceptor
axios.interceptors.response.use(
  function (response) {
    // Any status code that lie within the range of 2xx cause this function to trigger
    // Do something with response data
    return response;
  },
  function (error) {
    // Any status codes that falls outside the range of 2xx cause this function to trigger
    // Do something with response error
    return Promise.reject(error);
  }
);

//delete interceptor
const myInterceptor = axios.interceptors.request.use(function () {
  /*...*/
});
axios.interceptors.request.eject(myInterceptor);

//add interceptors to a custom instance of axios.
const instance = axios.create();
instance.interceptors.request.use(function () {
  /*...*/
});
```

## ðŸ‘¿Fetchã€Axios åŒºåˆ«å®žä¾‹

### post è¯·æ±‚

- Fetch å®žçŽ°ï¼š`url`ä½œä¸ºç¬¬ä¸€å‚æ•°ï¼›é…ç½®é¡¹`body`å±žæ€§æä¾›éœ€ä¼ è¾“çš„æ•°æ®ï¼Œä¸”éœ€`JSON.stringify`æ‰‹åŠ¨åºåˆ—åŒ–ï¼›èŽ·å–å“åº”æ•°æ®ä½¿ç”¨`response.json()`

```javascript
let url = "https://someurl.com";
let options = {
  method: "POST",
  mode: "cors",
  headers: {
    Accept: "application/json",
    "Content-Type": "application/json;charset=UTF-8",
  },
  body: JSON.stringify({
    property_one: value_one,
    property_two: value_two,
  }),
};
//awaitæ–¹æ³•
let response = await fetch(url, options);
if (response.ok) {
  let data = await response.json();
  // do something with data
} else {
  alert("HTTP-Error: " + response.status);
}
//promiseæ–¹æ³•
fetch(url, options)
  .then((response) => response.json())
  .then((data) => {
    console.log(data);
  })
  .catch((err) => {
    console.log(err);
  });
```

- Axios å®žçŽ°ï¼šé…ç½®é¡¹ä½œä¸ºå”¯ä¸€å¯¹è±¡å‚æ•°ï¼ŒåŒ…å«`url`ï¼›`data`å±žæ€§æä¾›éœ€ä¼ è¾“çš„æ•°æ®ï¼Œä¸éœ€æ‰‹åŠ¨åºåˆ—åŒ–ï¼›èŽ·å–å“åº”æ•°æ®ä½¿ç”¨`response.data`

```javascript
let url = "https://someurl.com";
let options = {
  method: "POST",
  url: url,
  headers: {
    Accept: "application/json",
    "Content-Type": "application/json;charset=UTF-8",
  },
  data: {
    property_one: value_one,
    property_two: value_two,
  },
};
//awaitæ–¹æ³•
let response = await axios(options);
if (response.status === 200 && response.statusText === "OK") {
  let data = await response.data;
  // do something with data
}
//promiseæ–¹æ³•
axios(options)
  .then((response) => response.data)
  .then((data) => {
    console.log(data);
  })
  .catch((err) => {
    console.log(err);
  });
```
